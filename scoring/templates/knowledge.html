<!DOCTYPE html>

{% load static %}

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LLM çŸ¥è¯†åº“ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <link rel="stylesheet" href="{% static 'css/materialdesignicons.min.css' %}">
    <link rel="stylesheet" href="{% static 'know/css/style.css' %}">

</head>
<body>
<header class="lyear-layout-header">
    <nav class="navbar navbar-default">
        <div class="topbar">

            <div class="topbar-left">
                <span class="navbar-page-title" style="font-size:30px"> LLM çŸ¥è¯†åº“ç®¡ç†ç³»ç»Ÿ</span>
            </div>
            <div class="topbar-left">
                <span class="navbar-page-title">&nbsp;</span>
            </div>
            <div class="topbar-left">
                <span class="navbar-page-title">&nbsp;</span>
            </div>
            <div class="topbar-left">
                <span class="navbar-page-title">&nbsp;</span>
            </div>
            <div class="topbar-left">
                <span class="navbar-page-title">&nbsp;</span>
            </div>
            <div class="topbar-left">
                <span class="navbar-page-title"><a href="/scoring/upload/">çŸ¥è¯†åº“ç®¡ç†</a></span>
                <span class="navbar-page-title"><a href="/nl2sql/nl2_upload/">æ™ºèƒ½é—®æ•°</a></span>
                <span class="navbar-page-title"><a href="/scoring/to_llm_id">æ™ºèƒ½é—®ç­”</a></span>
                {% if user.is_authenticated %}
                    <span class="navbar-page-title"><a href="/authing/profile/">ä¸ªäººä¿¡æ¯</a></span>
                    <span class="navbar-page-title"><a href="/authing/logout/">é€€å‡º</a></span>
                {% else %}
                    <span class="navbar-page-title"><a href="/authing/login/">ç™»å½•/æ³¨å†Œ</a></span>
                {% endif %}
            </div>
        </div>
    </nav>
</header>
<div class="wrapper" style="margin-top: 5%">
    <h2>çŸ¥è¯†åº“å»ºè®¾å®¹å™¨</h2>
    <div class="divider"></div> <!-- åˆ†å‰²çº¿ -->
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="file">* çŸ¥è¯†æ–‡ä»¶ä¸Šä¼ ï¼ˆè¯·æŒ‰ç…§ â¡ï¸ xlsxæ¨¡æ¿chunkè¿›è¡Œåˆ‡ç‰‡ä¸Šä¼ ï¼‰&nbsp;&nbsp;&nbsp;&nbsp;<a
                    href="{% url 'download' %}" download
                    style="color: #999999">ã€ç‚¹å‡»ğŸ‘†ä¸‹è½½çŸ¥è¯†åº“ä¸Šä¼ æ ‡å‡†æ¨¡æ¿æ–‡ä»¶ã€‘</a></label>
            <input type="file" name="file" id="file" accept=".xlsx"/>
        </div>
        <div class="form-group">
            <label for="name">* çŸ¥è¯†åº“åç§°</label>
            <input type="text" name="name" id="name"
                   placeholder="è¯·è¾“å…¥çŸ¥è¯†åº“åç§°ï¼ˆä»…æ”¯æŒå­—æ¯ä¸‹åˆ’çº¿æ•°å­—ã€ä¸”ä¸èƒ½ä»¥æ•°å­—å¼€å¤´ï¼‰"
                   oninput="validateInput(this)"/>
        </div>
        <div class="form-group">
            <label for="name">çŸ¥è¯†åº“ç®€ä»‹</label>
            <input type="text" name="content" id="content" placeholder="æè¿°ä¸€äº›å†…å®¹......"/>
        </div>
        <div class="form-group">
            <label for="name">* é€‰æ‹©çŸ¥è¯†åº“ç±»å‹åŠç®—æ³•</label>
            <select name="embedding" id="embedding">
                <option value="" disabled selected>è¯·é€‰æ‹©çŸ¥è¯†åº“ç±»å‹åŠç®—æ³•</option>
                <optgroup label="ElasticSearch" id="type">
                    <option value="ES@BM25">BM25</option>
                </optgroup>
                <optgroup label="Milvus" id="type">
                    <option value="Milvus@bge-base-zh">BGE Base</option>
                </optgroup>
            </select>
        </div>
        {% csrf_token %}
        <button type="submit">ç‚¹å‡»ğŸ‘†åˆ›å»ºçŸ¥è¯†åº“</button>
    </form>
</div>

<div class="wrapper">
    <h2>çŸ¥è¯†åº“ä¿¡æ¯å®¹å™¨</h2>
    <div class="divider"></div> <!-- åˆ†å‰²çº¿ -->
    <div class="row" id="carList"></div>
</div>
<!--End é¡µé¢ä¸»è¦å†…å®¹-->
<script>
    function validateInput(input) {
        // Get the current value of the input field
        const value = input.value;

        // Define regex to match valid characters (letters, numbers, and underscores) and filter out invalid characters
        const validCharsRegex = /^[a-zA-Z0-9_]*$/;

        // Remove characters that are not valid
        input.value = value.split('').filter(char => validCharsRegex.test(char)).join('');

        // Ensure the input does not start with a digit
        if (/^\d/.test(input.value)) {
            input.value = input.value.replace(/^\d/, '');
        }
    }

    // ä»DOMä¸­è·å–CSRFä»¤ç‰Œ
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    document.getElementById('uploadForm').onsubmit = function (event) {
        event.preventDefault();
        const formData = new FormData(this);
        alert('çŸ¥è¯†åº“å»ºè®¾å·²åœ¨åå°å¼€å§‹æ‰§è¡Œ');
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        fetch('/scoring/upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
            })
        location.reload();
    }

    document.addEventListener('DOMContentLoaded', function () {
        // è¿™ä¸ªå‡½æ•°ç”¨äºæ¸²æŸ“å¡ç‰‡
        function renderCards(data) {
            const carList = document.getElementById('carList');
            carList.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

            data.forEach(item => {
                const [name, type, id, statute] = item;
                const cardHtml = `
                <div class="col-sm-6 col-lg-3">
                    <div class="card">
                        <div class="card-header bg-info">
                            <h4 style="display: none">ID:${id}</h4>
                            <h4 style="white-space:nowrap;overflow:hidden;">åç§°:${name}</h4>
                            <h4 style="white-space:nowrap;overflow:hidden;">ç±»å‹:${type}</h4>
                            <h4 style="white-space:nowrap;overflow:hidden;">çŠ¶æ€:${statute}</h4>
                            <ul class="card-actions">
                                <li>
                                    <button type="button" onclick="fetchDetails('${id}')" ${statute === 'æ‰§è¡Œä¸­' ? 'disabled' : ''}>
                                    <i class="mdi mdi-more"></i>è¯¦æƒ…ä¿¡æ¯</button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
                carList.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        // è·å–æ•°æ®
        fetch('/scoring/select/')
            .then(response => response.json())
            .then(data => {
                renderCards(data.message);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    });

    function fetchDetails(id) {
        location.href = "/scoring/detail/" + id + "/"
    }


</script>
</body>
</html>